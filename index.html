<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokhematology Snap: Una Expedición Celular</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lilita+One&display=swap" rel="stylesheet">
    <!-- Icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-primary: #EFF6FF; /* Lighter Blue */
            --bg-secondary: #FFFFFF;
            --text-primary: #1F2937; /* Darker Gray */
            --accent-primary: #00A1E9; /* Sky Blue from Snap logo */
            --accent-secondary: #FFCB05; /* Bright Yellow from Snap logo */
            --action-color: #4DAD5B; /* Leafy Green */
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }
        h1, h2, h3 {
            font-family: 'Lilita One', cursive;
        }
        .view { display: none; width: 100%; height: 100vh; position: absolute; top: 0; left: 0; animation: fadeIn 0.5s ease-in-out; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .panel { background: var(--bg-secondary); border-radius: 24px; box-shadow: 0 10px 30px rgba(44, 62, 80, 0.15); border: 1px solid #e0e0e0; }
        .header-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(200, 200, 200, 0.5); }
        
        .scan-target { position: absolute; width: 90px; height: 90px; border-radius: 50%; background: rgba(255, 203, 5, 0.2); border: 3px dashed var(--accent-secondary); cursor: crosshair; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .scan-target:hover { transform: scale(1.15); background: rgba(255, 203, 5, 0.4); }
        .scan-target.scanned { background: rgba(77, 173, 91, 0.3); border: 3px solid var(--action-color); animation: none; cursor: default; }
        
        #recorrido-container { 
            background-size: 110% 110%; /* Make background slightly larger for parallax */
            background-position: center center; 
            transition: background-position 0.1s linear;
            overflow: hidden;
            cursor: crosshair;
        }

        @keyframes float1 { 0% { transform: translate(0, 0); } 50% { transform: translate(-20px, 25px); } 100% { transform: translate(0, 0); } }
        @keyframes float2 { 0% { transform: translate(0, 0); } 50% { transform: translate(25px, -20px); } 100% { transform: translate(0, 0); } }
        @keyframes float3 { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .float-anim-1 { animation: float1 10s ease-in-out infinite; }
        .float-anim-2 { animation: float2 12s ease-in-out infinite; }
        .float-anim-3 { animation: float3 8s ease-in-out infinite; }
        
        .map-point { 
            transition: all 0.3s ease;
            border-radius: 16px;
            width: 120px;
            height: 90px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border: 4px solid white; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        @media (min-width: 768px) { .map-point { width: 160px; height: 100px; } }
        .map-point:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 15px 25px rgba(0,0,0,0.2); }
        .map-point.explored {
            filter: grayscale(50%) brightness(0.8);
            border-color: #95a5a6;
        }
        .narrative-poke-img { display: inline-block; vertical-align: middle; height: 2.5rem; width: 2.5rem; margin: 0 0.5rem; border-radius: 50%; background-color: #f0f8ff; padding: 4px; border: 1px solid #e0e0e0; flex-shrink: 0; }
        .nav-link:disabled { color: #bdc3c7; cursor: not-allowed; background-color: transparent !important; }
        .action-button { background-color: var(--action-color); }
        .action-button:hover { background-color: #219d52; }
        #screen-flash { transition: opacity 0.3s ease-out; }
        #mini-map-container span { text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
    </style>
</head>
<body class="w-full h-screen overflow-hidden">

    <div id="screen-flash" class="fixed inset-0 bg-white opacity-0 pointer-events-none z-[100]"></div>

    <!-- BARRA DE NAVEGACIÓN -->
    <header id="main-header" class="fixed top-0 left-0 w-full p-2 md:p-4 z-50 header-panel">
        <nav class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-camera-retro text-2xl md:text-3xl text-accent-primary"></i>
                <h1 class="text-xl md:text-2xl text-accent-primary">Pokhematology Snap</h1>
            </div>
            <div class="space-x-1 md:space-x-2">
                <button data-view="narrativa" class="nav-link text-sm md:text-lg font-semibold hover:text-accent-primary transition-colors px-2 md:px-4 py-2 rounded-full hover:bg-blue-100">Narrativa</button>
                <button data-view="laboratorio" class="nav-link text-sm md:text-lg font-semibold hover:text-accent-primary transition-colors px-2 md:px-4 py-2 rounded-full hover:bg-blue-100" disabled>Laboratorio</button>
                <button data-view="mapa" class="nav-link text-sm md:text-lg font-semibold hover:text-accent-primary transition-colors px-2 md:px-4 py-2 rounded-full hover:bg-blue-100" disabled>Mapa</button>
                <button data-view="hemodex" class="nav-link text-sm md:text-lg font-semibold hover:text-accent-primary transition-colors px-2 md:px-4 py-2 rounded-full hover:bg-blue-100" disabled>Hemodex</button>
            </div>
        </nav>
    </header>

    <main class="w-full h-full">
        <!-- VISTA 1: LABORATORIO (INICIO) -->
        <section id="laboratorio" class="view flex-col items-center justify-center text-center p-4 md:p-8 bg-cover bg-center" style="background-image: url('https://placehold.co/1920x1080/a0d2eb/e0f7fa?text=Fondo+Ilustrado+del+Laboratorio');">
            <div class="panel p-6 md:p-10 max-w-3xl w-full mx-4">
                <h2 class="text-3xl md:text-5xl font-bold mb-4 text-accent-primary">¡Bienvenido a la Expedición!</h2>
                <p class="text-base md:text-lg mb-6 max-w-2xl mx-auto text-gray-600">Tu aventura de investigación está a punto de comenzar. Ingresa tu nombre para registrar tus descubrimientos.</p>
                <div class="mb-6">
                    <label for="student-name-input" class="sr-only">Nombre Completo</label>
                    <input type="text" id="student-name-input" class="w-full max-w-md mx-auto p-3 text-base md:text-lg border-2 border-gray-300 rounded-full text-center focus:ring-accent-primary focus:border-accent-primary" placeholder="Ingresa tu nombre completo...">
                </div>
                <button id="start-expedition-btn" class="action-button text-white font-bold py-3 px-8 md:py-4 md:px-10 rounded-full text-lg md:text-xl hover:bg-green-600 transition-transform hover:scale-105 transform shadow-lg">
                    Iniciar Expedición
                </button>
            </div>
        </section>

        <!-- VISTA 2: MAPA DE EXPEDICIÓN -->
        <section id="mapa" class="view flex-col items-center justify-center p-4 md:p-8" style="background-image: url('https://placehold.co/1920x1080/81c784/dcedc8?text=Mapa+Ilustrado+del+Cuerpo');">
             <div class="panel p-6 md:p-10 text-center w-full mx-4 max-w-5xl">
                <h2 class="text-2xl md:text-4xl font-bold mb-8 text-accent-primary">Mapa de la Expedición</h2>
                <div id="main-map-grid" class="flex flex-wrap justify-center items-center gap-4 md:gap-6">
                    <!-- Map points injected by JS -->
                </div>
            </div>
        </section>

        <!-- VISTA 3: RECORRIDO DE ESCANEO -->
        <section id="recorrido" class="view items-center justify-center">
            <div id="recorrido-container" class="relative w-full h-full"></div>
            <div class="absolute top-20 md:top-24 left-4 panel p-2 md:p-4">
                <h3 id="recorrido-title" class="text-lg md:text-2xl font-bold text-accent-primary"></h3>
                <p class="text-xs md:text-base text-gray-600">Apunta y haz clic para escanear.</p>
            </div>
            <!-- MINI MAP -->
            <div id="mini-map-container" class="absolute bottom-4 left-1/2 -translate-x-1/2 panel p-2 rounded-full flex justify-center items-center gap-2 md:gap-4">
                <!-- Mini map buttons will be injected here -->
            </div>
        </section>

        <!-- VISTA 4: HEMODEX -->
        <section id="hemodex" class="view flex-col items-center justify-start p-4 pt-24 md:p-8 md:pt-28 overflow-y-auto">
             <div class="text-center mb-8">
                <h2 class="text-3xl md:text-5xl font-bold mb-2 text-accent-primary">Hemodex Celular</h2>
                <p class="text-base md:text-lg text-gray-500">Tu enciclopedia de descubrimientos.</p>
            </div>
            <div class="mb-6 panel p-2 rounded-full flex flex-wrap justify-center items-center gap-2">
                 <button data-filter="all" class="filter-btn bg-accent-primary text-white font-semibold py-2 px-4 md:px-6 rounded-full text-sm">Todo</button>
                 <button data-filter="mieloide" class="filter-btn hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 md:px-6 rounded-full text-sm">L. Mieloide</button>
                 <button data-filter="linfoide" class="filter-btn hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 md:px-6 rounded-full text-sm">L. Linfoide</button>
                 <button id="download-pdf-btn" class="action-button text-white font-semibold py-2 px-4 md:px-6 rounded-full hover:bg-green-600 transition text-sm"><i class="fas fa-file-pdf mr-2"></i>Descargar Atlas</button>
            </div>
            <div id="hemodex-grid" class="container mx-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"></div>
        </section>

        <!-- VISTA 5: NARRATIVA COMPLETA -->
        <section id="narrativa" class="view active flex-col items-center justify-start p-4 pt-24 md:p-8 md:pt-28 overflow-y-auto">
             <div class="panel w-full max-w-4xl max-h-[85vh] overflow-y-auto p-6 md:p-12">
                <div id="narrative-content">
                    <h2 class="text-2xl md:text-4xl font-bold mb-6 text-accent-primary border-b-2 border-yellow-400 pb-2">Pokhematology: Clase de Hematopoyesis</h2>
                    
                    <h3 class="text-xl md:text-2xl font-bold mt-8 mb-3 text-gray-700">1. La aventura comienza en el laboratorio</h3>
                    <p class="text-base leading-relaxed text-gray-600 mb-4">¡Hola a todos! Nuestra aventura Pokémon no se desarrollará en Kanto o Johto, sino dentro de nuestro propio cuerpo. Hoy seremos científicos-entrenadores y exploraremos un lugar fascinante: la <strong>médula ósea</strong>.</p>
                    <p class="text-base leading-relaxed text-gray-600 mb-4">La médula ósea es un tejido blando y esponjoso dentro de los huesos. Funciona como un laboratorio avanzado donde se fabrican todas las células sanguíneas, pero también es un gimnasio donde estas células se entrenan y maduran, preparándose para proteger el organismo. Piensa en esta médula como ese lugar especial donde la ciencia y el entrenamiento convergen para preparar a los "Pokémon sanguíneos" más fuertes y especializados que tu cuerpo necesita.</p>

                    <h3 class="text-xl md:text-2xl font-bold mt-8 mb-3 text-gray-700">2. Las líneas de evolución y los “objetos especiales”</h3>
                    <div class="flex items-start mb-4"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/132.png" class="narrative-poke-img mt-1" alt="Ditto"><p class="text-base leading-relaxed text-gray-600">Desde <strong>Ditto</strong>, que simboliza a la <strong>célula madre hematopoyética pluripotente</strong>, surgen dos rutas evolutivas principales: la <strong>línea linfoide</strong>, que genera a los estrategas del sistema inmune (Linfocitos T y B), responsables de la inmunidad adaptativa: una defensa especializada y con memoria; y la <strong>línea mieloide</strong>, que produce a los luchadores de primera línea (granulocitos), los transportadores de oxígeno (glóbulos rojos) y los reparadores (plaquetas), siendo la base de la inmunidad innata.</p></div>
                    <p class="text-base leading-relaxed text-gray-600 mb-4">La transformación de estas células está regulada por factores de crecimiento, que puedes imaginar como los <strong>“objetos especiales”</strong> del mundo Pokémon:</p>
                    <ul class="list-disc list-inside text-gray-600 space-y-2 mb-4 pl-4">
                        <li>La <strong>eritropoyetina (EPO)</strong> actúa como una <em>Piedra Solar</em> para madurar glóbulos rojos.</li>
                        <li>La <strong>trombopoyetina (TPO)</strong> funciona como una <em>Piedra Lunar</em> para estimular plaquetas.</li>
                        <li>Factores como el <strong>G-CSF, GM-CSF</strong> o la <strong>IL-3</strong> son como <em>Caramelos Raros</em> que aceleran el crecimiento de granulocitos.</li>
                    </ul>
                    
                    <h3 class="text-xl md:text-2xl font-bold mt-8 mb-3 text-gray-700">3. Familias Pokémon de la sangre</h3>
                    <h4 class="text-lg md:text-xl font-semibold mt-6 mb-4 text-gray-600 border-b pb-2">3.1 Línea Linfoide: Estrategas y Asesinos</h4>
                    <div class="space-y-4">
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/63.png" class="narrative-poke-img" alt="Abra"><p class="text-base leading-relaxed text-gray-600">El <strong>progenitor linfoide común</strong> es como un <strong>Abra</strong> joven, lleno de potencial psíquico latente y listo para evolucionar.</p></div>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/64.png" class="narrative-poke-img" alt="Kadabra"><p class="text-base leading-relaxed text-gray-600">Al madurar, se convierte en un <strong>Kadabra</strong> (linfoblasto/prolinfocito), con capacidades más definidas y receptores listos para reconocer antígenos.</p></div>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/65.png" class="narrative-poke-img" alt="Alakazam"><p class="text-base leading-relaxed text-gray-600">Si este Kadabra viaja al "gimnasio" del timo para su entrenamiento de élite, evoluciona en un <strong>Linfocito T (Alakazam T)</strong>, el maestro estratega de la inmunidad celular. Si madura en la médula ósea, se desarrolla como un <strong>Linfocito B (Alakazam B)</strong>, que al ser activado se convierte en una célula plasmática, una "mega-evolución" capaz de producir en masa proyectiles de energía: los anticuerpos.</p></div>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/94.png" class="narrative-poke-img" alt="Gengar"><p class="text-base leading-relaxed text-gray-600">En paralelo, las <strong>células NK</strong> son como un ágil <strong>Gengar</strong>, un asesino silencioso que se mueve entre las sombras (tejidos) para eliminar rápidamente células infectadas y tumorales sin necesidad de un reconocimiento previo.</p></div>
                    </div>

                    <h4 class="text-lg md:text-xl font-semibold mt-6 mb-4 text-gray-600 border-b pb-2">3.2 Línea Mieloide: Defensores, Transportadores y Reparadores</h4>
                    <div class="space-y-4">
                        <p class="font-bold text-gray-700">Subfamilia A: Transporte (Línea Eritroide)</p>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png" class="narrative-poke-img" alt="Charmander"><p class="text-base leading-relaxed text-gray-600">Imagina al <strong>proeritroblasto</strong> como un <strong>Charmander</strong>, una célula joven con un gran núcleo y citoplasma azulado (basófilo), activa en la síntesis de hemoglobina.</p></div>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/5.png" class="narrative-poke-img" alt="Charmeleon"><p class="text-base leading-relaxed text-gray-600">Al recibir EPO, Charmander evoluciona a <strong>Charmeleon</strong> (eritroblasto), cuya tonalidad cambia de azul a rojo anaranjado mientras acumula hemoglobina y se prepara para expulsar su núcleo.</p></div>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png" class="narrative-poke-img" alt="Charizard"><p class="text-base leading-relaxed text-gray-600">Al perder el núcleo, se convierte en un <strong>reticulocito</strong>, un joven <strong>Charizard</strong> que aún conserva algunos ribosomas y ya circula en la sangre periférica, completando su maduración. Finalmente, se transforma en un <strong>eritrocito</strong>, un Charizard adulto listo para la batalla: flexible, bicóncavo y experto en transportar oxígeno.</p></div>
                        
                        <p class="font-bold text-gray-700 pt-4">Subfamilia B: Luchadores y Devoradores</p>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/133.png" class="narrative-poke-img" alt="Eevee"><p class="text-base leading-relaxed text-gray-600">El <strong>mieloblasto</strong> es como un <strong>Eevee</strong>, versátil y listo para evolucionar según las señales que reciba.</p></div>
                        <ul class="list-disc list-inside pl-8 text-gray-600 space-y-2">
                            <li class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/700.png" class="narrative-poke-img h-8 w-8" alt="Sylveon"><p>Bajo el estímulo de G-CSF, evoluciona a <strong>Neutrófilo (Sylveon)</strong>, el más abundante. Una forma inmadura de esta célula es el <strong>Neutrófilo en banda</strong>, análogo a un Sylveon joven, que al igual que el reticulocito, ya es funcional pero no ha completado su maduración.</p></li>
                            <li class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/136.png" class="narrative-poke-img h-8 w-8" alt="Flareon"><p>Con un estímulo de IL-5, se transforma en <strong>Eosinófilo (Flareon)</strong>, de color rojo intenso, experto en combatir parásitos y regular alergias.</p></li>
                            <li class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/134.png" class="narrative-poke-img h-8 w-8" alt="Vaporeon"><p>Bajo la influencia de IL-3 y señales de IgE, se convierte en un <strong>Basófilo</strong> (como un <strong>Vaporeon</strong> por su color azul-morado), que libera gránulos (histamina) para iniciar respuestas inflamatorias.</p></li>
                        </ul>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/129.png" class="narrative-poke-img" alt="Magikarp"><p class="text-base leading-relaxed text-gray-600">El <strong>monocito</strong> es un humilde <strong>Magikarp</strong> circulando en la sangre. Pero al llegar a los tejidos y recibir señales inflamatorias (M-CSF), sufre una transformación espectacular en un poderoso <strong>Gyarados</strong><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/130.png" class="narrative-poke-img" alt="Gyarados">: el <strong>macrófago</strong>, un gigante que devora patógenos, limpia desechos y dirige la respuesta inmune local.</p></div>

                        <p class="font-bold text-gray-700 pt-4">Subfamilia C: Reparadores (Línea Megacariocítica)</p>
                        <div class="flex items-start"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/76.png" class="narrative-poke-img" alt="Golem"><p class="text-base leading-relaxed text-gray-600">El <strong>megacariocito</strong> es un gigante <strong>Golem</strong>, tan grande que permanece inmóvil en la médula ósea. Su función es fragmentar su citoplasma para liberar <strong>plaquetas</strong>: las más grandes pueden ser como un <strong>Graveler</strong><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/75.png" class="narrative-poke-img" alt="Graveler">, mientras que las pequeñas y funcionales son como una horda de <strong>Geodude</strong><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/74.png" class="narrative-poke-img" alt="Geodude">, listos para agruparse y reparar cualquier grieta en los vasos sanguíneos (hemostasia).</p></div>
                    </div>
                    <h3 class="text-xl md:text-2xl font-bold mt-8 mb-3 text-gray-700">4. Gimnasios y campos de batalla</h3>
                    <p class="text-base leading-relaxed text-gray-600">La médula ósea es el Pueblo Paleta donde nacen y entrenan nuestros Pokémon. El timo es un gimnasio de élite exclusivo para los Linfocitos T. Los ganglios linfáticos y el bazo son las Ligas Pokémon, donde las células se reúnen, presentan antígenos y coordinan ataques masivos. Finalmente, los tejidos son el verdadero campo de batalla, donde se enfrentan a virus, bacterias y otros invasores.</p>
                </div>
                <!-- QUIZ SECTION -->
                <div id="narrative-quiz" class="mt-10 pt-6 border-t-2 border-dashed">
                    <h3 class="text-2xl font-bold text-accent-primary mb-4">Quiz de Comprensión</h3>
                    <p class="text-gray-600 mb-6">Responde correctamente para desbloquear la siguiente sección.</p>
                    <form id="quiz-form" class="space-y-6 text-left">
                        <div><p class="font-semibold mb-2">1. ¿Qué célula se representa con Ditto?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q1" value="a"> Linfocito T</label><label><input type="radio" name="q1" value="b"> Célula madre hematopoyética</label><label><input type="radio" name="q1" value="c"> Plaquetas</label></div></div>
                        <div><p class="font-semibold mb-2">2. ¿Qué línea celular es responsable de la inmunidad adaptativa (con memoria)?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q2" value="a"> Línea mieloide</label><label><input type="radio" name="q2" value="c"> Línea linfoide</label></div></div>
                        <div><p class="font-semibold mb-2">3. ¿Qué analogía representa la transformación de Monocito a Macrófago?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q3" value="a"> Abra a Alakazam</label><label><input type="radio" name="q3" value="b"> Magikarp a Gyarados</label><label><input type="radio" name="q3" value="c"> Charmander a Charizard</label></div></div>
                        <div><p class="font-semibold mb-2">4. ¿Qué factor de crecimiento es clave para la maduración de los glóbulos rojos?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q4" value="a"> Eritropoyetina (EPO)</label><label><input type="radio" name="q4" value="b"> G-CSF</label><label><input type="radio" name="q4" value="c"> Trombopoyetina (TPO)</label></div></div>
                        <div><p class="font-semibold mb-2">5. ¿Con qué Pokémon se compara al Megacariocito por su gran tamaño?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q5" value="a"> Snorlax</label><label><input type="radio" name="q5" value="b"> Golem</label><label><input type="radio" name="q5" value="c"> Gyarados</label></div></div>
                        <div><p class="font-semibold mb-2">6. El Mieloblasto, análogo a Eevee, es un progenitor de la línea...</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q6" value="a"> Mieloide</label><label><input type="radio" name="q6" value="b"> Linfoide</label></div></div>
                        <div><p class="font-semibold mb-2">7. ¿Cuál de estas células es como Sylveon, especializada en fagocitar bacterias?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q7" value="a"> Eosinófilo</label><label><input type="radio" name="q7" value="b"> Basófilo</label><label><input type="radio" name="q7" value="c"> Neutrófilo</label></div></div>
                        <div><p class="font-semibold mb-2">8. ¿Dónde ocurre el entrenamiento de élite de los Linfocitos T (Alakazam T)?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q8" value="a"> Pueblo Paleta Médula</label><label><input type="radio" name="q8" value="b"> Gimnasio del Timo</label><label><input type="radio" name="q8" value="c"> Liga Linfática</label></div></div>
                        <div><p class="font-semibold mb-2">9. ¿Qué célula es como un "Charizard Joven" que circula en la sangre antes de madurar por completo?</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q9" value="a"> Eritroblasto</label><label><input type="radio" name="q9" value="b"> Reticulocito</label><label><input type="radio" name="q9" value="c"> Proeritroblasto</label></div></div>
                        <div><p class="font-semibold mb-2">10. Verdadero o Falso: La línea linfoide produce plaquetas.</p><div class="flex flex-col space-y-2"><label><input type="radio" name="q10" value="a"> Verdadero</label><label><input type="radio" name="q10" value="b"> Falso</label></div></div>
                    </form>
                    <button id="check-quiz-btn" class="mt-8 action-button text-white font-bold py-3 px-8 rounded-full hover:bg-green-600 transition">Verificar Respuestas</button>
                    <p id="quiz-result" class="mt-4 font-semibold"></p>
                </div>
             </div>
        </section>
    </main>

    <footer class="fixed bottom-0 left-0 w-full text-center p-2 bg-gray-800 text-white text-xs z-50">
        © 2025 | Adriana A. Barrios Rodríguez | Patología Clínica II
    </footer>

    <!-- MODAL: FICHA DE DATOS -->
    <div id="ficha-modal" class="fixed inset-0 w-full h-full bg-black/50 flex items-center justify-center z-50 p-4 hidden">
        <div class="panel w-full max-w-4xl max-h-[90vh] overflow-y-auto relative animate-fadeIn p-6 md:p-8">
            <button id="close-modal-btn" class="absolute top-4 right-6 text-3xl text-gray-400 hover:text-accent-primary">&times;</button>
            <div class="text-center mb-6">
                <h2 id="ficha-cell-name" class="text-2xl md:text-4xl font-bold text-accent-primary"></h2>
                <p id="ficha-poke-name" class="text-base md:text-lg text-gray-500"></p>
            </div>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                    <h3 class="text-xl font-semibold mb-2">Análogo Pokémon</h3>
                    <div class="w-full h-64 rounded-lg bg-gray-200 flex items-center justify-center p-2">
                        <img id="ficha-poke-img-tag" src="" alt="Foto del Pokémon" class="max-w-full max-h-full object-contain">
                    </div>
                </div>
                <div class="flex flex-col items-center p-4 bg-gray-100 rounded-xl">
                    <h3 class="text-xl font-semibold mb-2">Scan Celular</h3>
                    <div class="w-full h-64 rounded-lg bg-gray-200 flex items-center justify-center p-2">
                         <img id="ficha-cell-img-tag" src="" alt="Foto de la Célula" class="max-w-full max-h-full object-contain">
                        <div id="ficha-cell-placeholder" class="text-center text-gray-500">
                            <i class="fas fa-image text-4xl mb-2"></i>
                            <p>Sube tu micrografía</p>
                        </div>
                    </div>
                    <input type="file" id="upload-cell-photo" class="hidden" accept="image/*">
                    <label for="upload-cell-photo" class="mt-4 inline-block action-button text-white font-bold py-2 px-6 rounded-full cursor-pointer transition">
                        <i class="fas fa-upload mr-2"></i>Cargar Foto
                    </label>
                </div>
            </div>
            <div>
                <h3 class="text-2xl font-bold mb-2 text-accent-primary border-b-2 border-yellow-400 pb-2">Reporte de Investigación</h3>
                <p id="ficha-text" class="text-base leading-relaxed text-gray-700 mt-4"></p>
                <div class="mt-6">
                    <label for="ficha-research-notes" class="block text-lg font-semibold text-gray-700 mb-2">Mis Notas de Investigación:</label>
                    <textarea id="ficha-research-notes" rows="8" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-accent-primary focus:border-accent-primary" placeholder="Añade aquí tus observaciones sobre la célula..."></textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-lg font-semibold text-gray-700 mb-2">Fuentes (URL):</label>
                    <div id="source-list" class="space-y-2"></div>
                    <button id="add-source-btn" class="mt-2 text-sm text-accent-primary hover:underline">+ Añadir más fuentes</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            let studentName = '';
            let narrativeQuizPassed = false;
            let studentNameEntered = false;
            let researchNoteTemplate = `Tamaño: \nForma: \nDescripción del núcleo y Citoplasma: \nRelación Núcleo/Citoplasma: \nOrganelas y/o inclusiones evidentes: \nSitio del cuerpo donde se pueden encontrar: \nPatologías en las que se encuentra esta célula: \nDatos adicionales:`;

            // --- DATABASE ---
            const hemoData = {
                'ditto': { name: 'Célula Madre Hematopoyética Pluripotente', pokemon: 'Ditto', line: 'none', location: 'medula', text: 'La Célula Madre Hematopoyética Pluripotente es como un Ditto; de ella surgen las dos grandes líneas evolutivas: la linfoide y la mieloide.', analogy: 'Porque, al igual que la célula madre, puede transformarse en cualquier otra célula.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/132.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'abra': { name: 'Progenitor Linfoide Común', pokemon: 'Abra', line: 'linfoide', location: 'medula', text: 'El progenitor linfoide común es como un Abra joven, lleno de potencial psíquico latente y listo para evolucionar.', analogy: 'Representa el potencial no especializado, listo para un camino evolutivo.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/63.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'eevee': { name: 'Mieloblasto', pokemon: 'Eevee', line: 'mieloide', location: 'medula', text: 'El mieloblasto es como un Eevee, versátil y listo para evolucionar según las señales que reciba.', analogy: 'Al igual que Eevee, puede evolucionar en múltiples tipos diferentes (neutrófilo, eosinófilo, basófilo) según el estímulo.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/133.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'kadabra': { name: 'Linfoblasto / Prolinfocito', pokemon: 'Kadabra', line: 'linfoide', location: 'timo', text: 'El Linfoblasto/Prolinfocito es la siguiente etapa, como un Kadabra que ha desarrollado capacidades más definidas y receptores para reconocer antígenos.', analogy: 'Es una etapa intermedia de maduración, más poderosa que la inicial pero aún no completamente especializada.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/64.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'alakazam-t': { name: 'Linfocito T', pokemon: 'Alakazam T', line: 'linfoide', location: 'timo', text: 'Si el linfoblasto entrena en el timo, se convierte en un Linfocito T, el maestro estratega de la inmunidad celular, análogo a la evolución final de Alakazam.', analogy: 'Representa la máxima especialización y poder estratégico de la inmunidad celular.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/65.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'charmander': { name: 'Proeritroblasto', pokemon: 'Charmander', line: 'mieloide', location: 'factoria', text: 'Imagina al proeritroblasto como un Charmander, una célula joven con un gran núcleo y citoplasma azulado (basófilo), activa en la síntesis de hemoglobina.', analogy: 'Es la primera etapa reconocible de la línea, llena de potencial para transportar "fuego" (oxígeno).', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/4.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'charmeleon': { name: 'Eritroblasto', pokemon: 'Charmeleon', line: 'mieloide', location: 'factoria', text: 'El Proeritroblasto, al recibir EPO, evoluciona en un Eritroblasto. Es como un Charmeleon cuya tonalidad cambia de azul a rojo anaranjado mientras acumula hemoglobina.', analogy: 'La célula cambia de color (de azul a rojo) a medida que madura, similar al cambio de color de Charmander a Charmeleon.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/5.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'charizard-joven': { name: 'Reticulocito', pokemon: 'Charizard Joven', line: 'mieloide', location: 'factoria', text: 'Cuando el Eritroblasto pierde su núcleo, se convierte en un Reticulocito. Es como un joven Charizard que ya circula en la sangre mientras termina de madurar.', analogy: 'Es casi la forma final, ya funcional pero aún con rastros de inmadurez, como un Charizard que recién aprendió a volar.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'charizard-adulto': { name: 'Eritrocito', pokemon: 'Charizard Adulto', line: 'mieloide', location: 'factoria', text: 'La maduración final del Reticulocito da lugar al Eritrocito. Es el análogo a un Charizard adulto, flexible y listo para su misión de transportar oxígeno.', analogy: 'La forma final, completamente madura y especializada para su función principal.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'sylveon': { name: 'Neutrófilo', pokemon: 'Sylveon', line: 'mieloide', location: 'granulitos', text: 'Bajo el estímulo de G-CSF, el Mieloblasto (Eevee) evoluciona a un Neutrófilo, que es como un Sylveon. Una forma inmadura es el Neutrófilo en banda, análogo a un Sylveon joven.', analogy: 'Se asocia con Sylveon por su coloración neutra (rosa pálido) en la tinción y su función defensora.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/700.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'flareon': { name: 'Eosinófilo', pokemon: 'Flareon', line: 'mieloide', location: 'granulitos', text: 'Con un estímulo de IL-5, el Mieloblasto (Eevee) evoluciona a un Eosinófilo. Este es como un Flareon de color rojo intenso, experto en combatir parásitos.', analogy: 'Sus gránulos se tiñen de rojo intenso (eosina), similar al color de Flareon. Ambos combaten amenazas específicas (parásitos/fuego).', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/136.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'vaporeon': { name: 'Basófilo', pokemon: 'Vaporeon', line: 'mieloide', location: 'granulitos', text: 'Bajo la influencia de IL-3, el Mieloblasto (Eevee) evoluciona a un Basófilo. Es como un Vaporeon por su color azul-morado, y libera gránulos (histamina) para iniciar respuestas inflamatorias.', analogy: 'Sus gránulos se tiñen de azul/morado intenso (hematoxilina), evocando a Vaporeon. Libera "chorros" de histamina.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/134.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'magikarp': { name: 'Monocito', pokemon: 'Magikarp', line: 'mieloide', location: 'lago', text: 'El monocito es un humilde Magikarp circulando en la sangre, pero tiene un gran potencial.', analogy: 'Parece simple mientras circula, pero tiene un potencial de transformación inmenso, como Magikarp.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/129.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'gyarados': { name: 'Macrófago', pokemon: 'Gyarados', line: 'mieloide', location: 'lago', text: 'Al llegar a los tejidos, el Monocito (Magikarp) sufre una transformación espectacular y se convierte en un Macrófago, que es como un poderoso Gyarados: un gigante que devora patógenos y limpia desechos.', analogy: 'Sufre una transformación radical de una forma circulante a un gigante tisular, al igual que Magikarp evoluciona a Gyarados.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/130.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'golem': { name: 'Megacariocito', pokemon: 'Golem', line: 'mieloide', location: 'caverna', text: 'El megacariocito es un gigante Golem, tan grande que permanece inmóvil en la médula ósea. Su función es fragmentar su citoplasma para liberar plaquetas.', analogy: 'Es una célula gigante e inmóvil, como Golem, que se fragmenta para crear vida nueva (plaquetas).', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/76.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'graveler': { name: 'Plaquetas Gigantes', pokemon: 'Graveler', line: 'mieloide', location: 'caverna', text: 'El Megacariocito (Golem) fragmenta su citoplasma para liberar plaquetas. Las más grandes son como un Graveler.', analogy: 'Representan los fragmentos grandes y potentes del "padre" Golem.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/75.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'geodude': { name: 'Plaquetas', pokemon: 'Geodude', line: 'mieloide', location: 'caverna', text: 'Las plaquetas pequeñas y funcionales son como una horda de Geodude, listas para agruparse y reparar cualquier grieta en los vasos sanguíneos (hemostasia).', analogy: 'Son las unidades más pequeñas y numerosas, que se agrupan para formar una barrera, como una horda de Geodude.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/74.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'alakazam-b': { name: 'Linfocito B', pokemon: 'Alakazam B', line: 'linfoide', location: 'liga', text: 'Si el linfoblasto madura en la médula ósea, se convierte en un Linfocito B. Al activarse, evoluciona a una célula plasmática, una "mega-evolución" como Alakazam, capaz de producir anticuerpos.', analogy: 'Representa la evolución estratégica que, en lugar de coordinar, produce "ataques especiales" (anticuerpos).', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/65.png', researchNotes: '', sourceLinks: [], captureDate: null },
                'gengar': { name: 'Célula Natural Killer (NK)', pokemon: 'Gengar', line: 'linfoide', location: 'liga', text: 'En paralelo, las células NK son como un ágil Gengar, un asesino silencioso que se mueve entre las sombras (tejidos) para eliminar rápidamente células infectadas y tumorales sin necesidad de un reconocimiento previo.', analogy: 'Actúa de forma rápida y letal sin necesidad de una orden previa, como un Pokémon de tipo fantasma que ataca por sorpresa.', scanned: false, cellImageUrl: null, fixedPokeImageUrl: 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/94.png', researchNotes: '', sourceLinks: [], captureDate: null }
            };
            
            const locationInfo = {
                medula: { title: "Pueblo Paleta Médula", bg: "https://placehold.co/1920x1080/c34a4a/f5c8c8?text=Pueblo+Paleta+Médula" },
                timo: { title: "Gimnasio del Timo", bg: "https://placehold.co/1920x1080/8e44ad/d5b4e7?text=Gimnasio+del+Timo" },
                factoria: { title: "Factoría Eritroide", bg: "https://placehold.co/1920x1080/e74c3c/f5b7b1?text=Factoría+Eritroide" },
                granulitos: { title: "Zona de Granulitos", bg: "https://placehold.co/1920x1080/f39c12/fdebd0?text=Zona+de+Granulitos" },
                lago: { title: "Lago de los Magikarp", bg: "https://placehold.co/1920x1080/3498db/aed6f1?text=Lago+de+los+Magikarp" },
                caverna: { title: "Caverna Golem", bg: "https://placehold.co/1920x1080/7f8c8d/eaeded?text=Caverna+Golem" },
                liga: { title: "Liga Linfática", bg: "https://placehold.co/1920x1080/4a00e0/d2b4de?text=Liga+Linfática" }
            };

            const studentNameInput = document.getElementById('student-name-input');
            const fichaCellImgTag = document.getElementById('ficha-cell-img-tag');
            const fichaCellPlaceholder = document.getElementById('ficha-cell-placeholder');
            const uploadCellPhotoInput = document.getElementById('upload-cell-photo');
            const fichaPokeImgTag = document.getElementById('ficha-poke-img-tag');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const researchNotesInput = document.getElementById('ficha-research-notes');
            const sourceList = document.getElementById('source-list');
            const addSourceBtn = document.getElementById('add-source-btn');
            const checkQuizBtn = document.getElementById('check-quiz-btn');
            const quizResult = document.getElementById('quiz-result');
            const quizForm = document.getElementById('quiz-form');
            const screenFlash = document.getElementById('screen-flash');
            const mainMapGrid = document.getElementById('main-map-grid');

            const dom = {
                views: document.querySelectorAll('.view'),
                navLinks: document.querySelectorAll('.nav-link'),
                startBtn: document.getElementById('start-expedition-btn'),
                recorrido: { container: document.getElementById('recorrido-container'), title: document.getElementById('recorrido-title') },
                hemodex: { grid: document.getElementById('hemodex-grid'), filters: document.querySelectorAll('.filter-btn') },
                modal: {
                    el: document.getElementById('ficha-modal'),
                    closeBtn: document.getElementById('close-modal-btn'),
                    cellName: document.getElementById('ficha-cell-name'),
                    pokeName: document.getElementById('ficha-poke-name'),
                    text: document.getElementById('ficha-text'),
                }
            };

            const updateNavStatus = () => {
                const labButton = document.querySelector('[data-view="laboratorio"]');
                const mapButton = document.querySelector('[data-view="mapa"]');
                const hemodexButton = document.querySelector('[data-view="hemodex"]');

                labButton.disabled = !narrativeQuizPassed;
                mapButton.disabled = !narrativeQuizPassed || !studentNameEntered;
                hemodexButton.disabled = !narrativeQuizPassed || !studentNameEntered;
            };

            const showView = (viewId) => {
                dom.views.forEach(view => view.classList.remove('active'));
                document.getElementById(viewId)?.classList.add('active');
                if (viewId === 'mapa') renderMainMap();
                if (viewId === 'hemodex') renderHemodex();
            };
            
            const triggerFlash = () => {
                screenFlash.style.opacity = '0.7';
                setTimeout(() => {
                    screenFlash.style.opacity = '0';
                }, 150);
            };
            
            const journeyOrder = ['medula', 'timo', 'factoria', 'granulitos', 'lago', 'caverna', 'liga'];

            const renderMainMap = () => {
                mainMapGrid.innerHTML = '';
                const mainButton = document.createElement('button');
                mainButton.dataset.location = journeyOrder[0];
                mainButton.className = `action-button text-white font-bold py-4 px-10 rounded-full text-xl hover:bg-green-600 transition-transform hover:scale-105 transform shadow-lg`;
                mainButton.innerHTML = 'Iniciar Viaje';
                mainButton.addEventListener('click', () => startRecorrido(journeyOrder[0]));
                mainMapGrid.appendChild(mainButton);
            };


            const startRecorrido = (locationId) => {
                const { container, title } = dom.recorrido;
                container.innerHTML = '';
                const miniMapContainer = document.getElementById('mini-map-container');
                miniMapContainer.innerHTML = ''; // Clear previous mini-map
                const locationData = locationInfo[locationId];
                title.textContent = locationData.title;
                container.style.backgroundImage = `url('${locationData.bg}')`;

                const currentIndex = journeyOrder.indexOf(locationId);
                const prevIndex = currentIndex > 0 ? currentIndex - 1 : null;
                const nextIndex = currentIndex < journeyOrder.length - 1 ? currentIndex + 1 : null;

                if (prevIndex !== null) {
                    const prevBtn = document.createElement('button');
                    prevBtn.innerHTML = `<i class="fas fa-arrow-left"></i>`;
                    prevBtn.className = 'p-2 rounded-full bg-black/50 text-white';
                    prevBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startRecorrido(journeyOrder[prevIndex])
                    });
                    miniMapContainer.appendChild(prevBtn);
                }

                const currentZoneText = document.createElement('span');
                currentZoneText.textContent = locationData.title;
                currentZoneText.className = 'text-white font-bold px-4';
                miniMapContainer.appendChild(currentZoneText);

                if (nextIndex !== null) {
                    const nextBtn = document.createElement('button');
                    nextBtn.innerHTML = `<i class="fas fa-arrow-right"></i>`;
                    nextBtn.className = 'p-2 rounded-full bg-black/50 text-white';
                    nextBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startRecorrido(journeyOrder[nextIndex])
                    });
                    miniMapContainer.appendChild(nextBtn);
                }
                
                Object.entries(hemoData).filter(([, v]) => v.location === locationId).forEach(([key, value]) => {
                    const target = document.createElement('div');
                    target.className = 'scan-target';
                    const animClass = `float-anim-${(Math.floor(Math.random() * 3) + 1)}`;
                    target.classList.add(animClass);
                    target.dataset.id = key;
                    target.innerHTML = `<i class="fas ${value.scanned ? 'fa-check' : 'fa-search'} text-white text-3xl"></i>`;
                    if(value.scanned) target.classList.add('scanned');
                    target.style.top = `${10 + (Math.random() * 70)}%`;
                    target.style.left = `${10 + (Math.random() * 70)}%`;
                    container.appendChild(target);
                });
                showView('recorrido');
            };

            const showFicha = (itemId) => {
                const data = hemoData[itemId];
                if (!data) return;
                
                const { el, cellName, pokeName, text } = dom.modal;
                el.dataset.id = itemId;
                cellName.innerHTML = `<strong>${data.name}</strong>`;
                pokeName.textContent = `Análogo: ${data.pokemon}`;
                text.textContent = data.text;
                
                researchNotesInput.value = data.researchNotes || researchNoteTemplate;
                renderSourceLinks(itemId);

                if (data.cellImageUrl) {
                    fichaCellImgTag.src = data.cellImageUrl;
                    fichaCellImgTag.style.display = 'block';
                    fichaCellPlaceholder.style.display = 'none';
                } else {
                    fichaCellImgTag.style.display = 'none';
                    fichaCellPlaceholder.style.display = 'flex';
                }
                
                fichaPokeImgTag.src = data.fixedPokeImageUrl;
                
                el.style.display = 'flex';
            };
            
            const renderHemodex = (filter = 'all') => {
                const { grid } = dom.hemodex;
                grid.innerHTML = '';
                Object.entries(hemoData).forEach(([key, value]) => {
                    if (filter !== 'all' && value.line !== filter) return;
                    
                    const card = document.createElement('div');
                    card.className = 'hemodex-card panel p-4 text-center transition-all transform hover:-translate-y-2';
                    card.dataset.id = key;
                    
                    if (value.scanned) {
                        card.classList.add('cursor-pointer');
                        const cellImg = value.cellImageUrl || 'https://placehold.co/100x75/e9ecef/495057?text=Foto';
                        const pokeImg = value.fixedPokeImageUrl;
                        card.innerHTML = `
                            <div class="w-full h-[88px] grid grid-cols-2 gap-1 bg-gray-200 items-center justify-center mb-2 overflow-hidden p-1">
                                <img src="${pokeImg}" alt="${value.pokemon}" class="max-w-full max-h-full object-contain h-full w-full">
                                <img src="${cellImg}" alt="${value.name}" class="max-w-full max-h-full object-cover h-full w-full">
                            </div>
                            <p class="font-bold text-sm text-accent-primary">${value.name}</p>
                            <p class="text-xs text-gray-500">${value.pokemon}</p>
                        `;
                    } else {
                        card.classList.add('locked');
                        card.innerHTML = `
                            <div class="w-full h-[88px] bg-gray-200 rounded-lg flex items-center justify-center mb-2"><span class="text-4xl font-bold text-gray-400">?</span></div>
                            <h4 class="font-bold text-lg text-gray-500">???</h4>
                            <p class="text-xs text-gray-400">Desconocido</p>
                        `;
                    }
                    grid.appendChild(card);
                });
            };

            const handlePhotoUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                triggerFlash();
                const reader = new FileReader();
                reader.onload = () => {
                    const dataURL = reader.result;
                    const itemId = dom.modal.el.dataset.id;
                    if (itemId && hemoData[itemId]) {
                        hemoData[itemId].cellImageUrl = dataURL;
                        fichaCellImgTag.src = dataURL;
                        fichaCellImgTag.style.display = 'block';
                        fichaCellPlaceholder.style.display = 'none';
                        renderHemodex();
                        saveProgress();
                    }
                };
                reader.readAsDataURL(file);
                event.target.value = null;
            };
            
            const loadImage = (url) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = (err) => {
                        console.error(`Failed to load image: ${url}`, err);
                        const placeholder = new Image();
                        placeholder.crossOrigin = 'Anonymous';
                        placeholder.src = `https://placehold.co/400x300/e9ecef/495057?text=Error`;
                        placeholder.onload = () => resolve(placeholder);
                        placeholder.onerror = () => reject(err);
                    };
                    img.src = url;
                });
            };

            async function generatePDF() {
                const btn = downloadPdfBtn;
                if (!studentName) {
                    alert('Por favor, regresa a la sección "Laboratorio" e ingresa tu nombre completo.');
                    return;
                }
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generando...`;

                const doc = new jsPDF('p', 'mm', 'a4');
                const scannedEntries = Object.values(hemoData).filter(v => v.scanned);
                if (scannedEntries.length === 0) {
                    alert('¡No has escaneado ninguna célula! Explora un poco y vuelve a intentarlo.');
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-file-pdf mr-2"></i>Descargar Atlas PDF`;
                    return;
                }
                
                const addFooter = (docInstance) => {
                    const pageCount = docInstance.internal.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        docInstance.setPage(i);
                        docInstance.setFontSize(8);
                        docInstance.setTextColor(150);
                        docInstance.text('© 2025 | Adriana A. Barrios Rodríguez | Patología Clínica II', docInstance.internal.pageSize.getWidth() / 2, 290, { align: 'center' });
                    }
                };

                // Title Page
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(28);
                doc.setTextColor('#3498db');
                doc.text('Atlas de Pokhematology', 105, 130, null, null, 'center');
                doc.setFontSize(18);
                doc.setTextColor('#2c3e50');
                doc.text(`Investigador: ${studentName}`, 105, 150, null, null, 'center');
                doc.setFontSize(12);
                doc.text(`Fecha de Creación: ${new Date().toLocaleDateString('es-ES')}`, 105, 160, null, null, 'center');
                doc.setFontSize(10);
                doc.text('Diseñado por:', 105, 275, null, null, 'center');
                
                // Prologue Page
                doc.addPage();
                doc.setFont('Helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor('#3498db');
                doc.text('Prólogo: La Historia de la Hematopoyesis', 15, 20);
                doc.setFont('Helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor('#2c3e50');
                const narrativeText = document.getElementById('narrative-content').innerText.replace('Pokhematology: Clase de Hematopoyesis', '').replace(/Quiz de Comprensión.*/s, '').trim();
                const splitNarrative = doc.splitTextToSize(narrativeText, 180);
                doc.text(splitNarrative, 15, 35);
                
                let lastY = 35 + (splitNarrative.length * 4) + 10;
                doc.setFont('Helvetica', 'bolditalic');
                doc.setTextColor('#e74c3c');
                const noteText = doc.splitTextToSize('NOTA: Esta es una versión simplificada de la hematopoyesis. Se deberán consultar libros especializados para profundizar en el proceso.', 180);
                doc.text(noteText, 15, lastY);


                for (let i = 0; i < scannedEntries.length; i++) {
                    const entry = scannedEntries[i];
                    doc.addPage();
                    
                    doc.setFont('Helvetica', 'bold');
                    doc.setFontSize(22);
                    doc.setTextColor('#3498db');
                    doc.text(entry.name, 15, 20);

                    doc.setFont('Helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.setTextColor('#2c3e50');
                    doc.text(`Análogo Pokémon: ${entry.pokemon}`, 15, 28);
                    
                    const cellImgSrc = entry.cellImageUrl || 'https://placehold.co/400x300/e9ecef/495057?text=Sin+Imagen';
                    const pokeImgSrc = entry.fixedPokeImageUrl;
                    
                    const x = 15, y = 40, w = 85, h = 64;
                    const padding = 3;
                    const bottomMargin = 12;
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(x - padding, y - padding, w + (padding * 2), h + padding + bottomMargin, 'FD');

                    try {
                        const cellImg = await loadImage(cellImgSrc);
                        doc.addImage(cellImg, 'JPEG', x, y, w, h);
                    } catch (e) { console.error('Error rendering cell image:', e); }

                    doc.setFont('Helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor('#555555');
                    const formattedDate = entry.captureDate ? new Date(entry.captureDate).toLocaleDateString('es-ES') : 'Fecha no registrada';
                    doc.text(formattedDate, x, y + h + 8);
                    
                    try {
                        const pokeImg = await loadImage(pokeImgSrc);
                        doc.addImage(pokeImg, 'PNG', 110, 40, 85, 64);
                    } catch (e) { console.error('Error rendering Pokémon image:', e); }

                    let currentY = y + h + bottomMargin + 15;
                    doc.setFont('Helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.setTextColor('#3498db');
                    doc.text('Analogía Pokémon:', 15, currentY);
                    currentY += 5;
                    doc.setFont('Helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor('#2c3e50');
                    const analogyText = doc.splitTextToSize(entry.analogy, 180);
                    doc.text(analogyText, 15, currentY);
                    currentY += (analogyText.length * 4) + 5;
                    
                    if (entry.researchNotes && entry.researchNotes.trim() !== researchNoteTemplate.trim()) {
                        doc.setFont('Helvetica', 'bold');
                        doc.setFontSize(11);
                        doc.setTextColor('#3498db');
                        doc.text('Notas del Investigador:', 15, currentY);
                        currentY += 5;
                        doc.setFont('Helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor('#2c3e50');
                        const notesText = doc.splitTextToSize(entry.researchNotes, 180);
                        doc.text(notesText, 15, currentY);
                        currentY += (notesText.length * 4) + 5;
                    }

                    if (entry.sourceLinks && entry.sourceLinks.filter(l => l).length > 0) {
                        doc.setFont('Helvetica', 'bold');
                        doc.setFontSize(11);
                        doc.setTextColor('#3498db');
                        doc.text('Fuentes:', 15, currentY);
                        currentY += 5;
                        doc.setFont('Helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor('#0000EE');
                        entry.sourceLinks.forEach(link => {
                            if (link) {
                                doc.textWithLink(link, 15, currentY, { url: link });
                                currentY += 5;
                            }
                        });
                    }
                }
                
                addFooter(doc);
                doc.save(`Atlas_Pokhematology_${studentName.replace(/ /g, '_')}.pdf`);
                btn.disabled = false;
                btn.innerHTML = `<i class="fas fa-file-pdf mr-2"></i>Descargar Atlas PDF`;
            }

            const renderSourceLinks = (itemId) => {
                sourceList.innerHTML = '';
                const data = hemoData[itemId];
                if (!data.sourceLinks || data.sourceLinks.length === 0) {
                    data.sourceLinks = [''];
                }
                data.sourceLinks.forEach((link, index) => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full p-2 border border-gray-300 rounded-lg focus:ring-accent-primary focus:border-accent-primary source-link-input';
                    input.placeholder = `https://ejemplo.com/fuente-${index + 1}`;
                    input.value = link;
                    input.dataset.index = index;
                    sourceList.appendChild(input);
                });
            };

            const saveProgress = () => {
                const progress = {
                    studentName,
                    narrativeQuizPassed,
                    studentNameEntered,
                    hemoData,
                };
                localStorage.setItem('pokhematologyProgress', JSON.stringify(progress));
            };

            const loadProgress = () => {
                const progress = JSON.parse(localStorage.getItem('pokhematologyProgress'));
                if (progress) {
                    studentName = progress.studentName || '';
                    narrativeQuizPassed = progress.narrativeQuizPassed || false;
                    studentNameEntered = progress.studentNameEntered || false;
                    Object.assign(hemoData, progress.hemoData);
                    studentNameInput.value = studentName;
                }
            };


            // --- EVENT LISTENERS ---
            dom.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (!e.target.disabled) {
                        showView(e.target.dataset.view)
                    }
                });
            });

            dom.startBtn.addEventListener('click', () => {
                studentName = studentNameInput.value.trim();
                if (studentName) {
                    studentNameEntered = true;
                    updateNavStatus();
                    showView('mapa');
                    saveProgress();
                } else {
                    alert('Por favor, ingresa tu nombre completo para comenzar la expedición.');
                }
            });

            checkQuizBtn.addEventListener('click', () => {
                const formData = new FormData(quizForm);
                const answers = {
                    q1: formData.get('q1'), q2: formData.get('q2'), q3: formData.get('q3'),
                    q4: formData.get('q4'), q5: formData.get('q5'), q6: formData.get('q6'),
                    q7: formData.get('q7'), q8: formData.get('q8'), q9: formData.get('q9'),
                    q10: formData.get('q10')
                };
                
                if (answers.q1 === 'b' && answers.q2 === 'c' && answers.q3 === 'b' && answers.q4 === 'a' && answers.q5 === 'b' && answers.q6 === 'a' && answers.q7 === 'c' && answers.q8 === 'b' && answers.q9 === 'b' && answers.q10 === 'b') {
                    quizResult.textContent = '¡Correcto! Has desbloqueado el Laboratorio.';
                    quizResult.style.color = 'green';
                    narrativeQuizPassed = true;
                    updateNavStatus();
                    saveProgress();
                } else {
                    quizResult.textContent = 'Algunas respuestas son incorrectas. ¡Revisa la narrativa y vuelve a intentarlo!';
                    quizResult.style.color = 'red';
                }
            });

            dom.recorrido.container.addEventListener('click', (e) => {
                const target = e.target.closest('.scan-target');
                if (target && !target.classList.contains('scanned')) {
                    const itemId = target.dataset.id;
                    hemoData[itemId].scanned = true;
                    hemoData[itemId].captureDate = new Date();
                    target.classList.add('scanned');
                    target.innerHTML = `<i class="fas fa-check text-white text-3xl"></i>`;
                    triggerFlash();
                    showFicha(itemId);
                    saveProgress();
                }
            });
            dom.recorrido.container.addEventListener('mousemove', (e) => {
                const { clientX, clientY } = e;
                const { innerWidth, innerHeight } = window;
                const percentX = (clientX / innerWidth - 0.5) * 2;
                const percentY = (clientY / innerHeight - 0.5) * 2;
                dom.recorrido.container.style.backgroundPosition = `${50 + percentX * 5}% ${50 + percentY * 5}%`;
            });
            dom.modal.closeBtn.addEventListener('click', () => dom.modal.el.style.display = 'none');
            dom.modal.el.addEventListener('click', (e) => { if (e.target === dom.modal.el) dom.modal.el.style.display = 'none'; });
            dom.hemodex.grid.addEventListener('click', (e) => {
                const card = e.target.closest('.hemodex-card');
                if (card && !card.classList.contains('locked')) showFicha(card.dataset.id);
            });
            dom.hemodex.filters.forEach(btn => btn.addEventListener('click', (e) => {
                dom.hemodex.filters.forEach(b => b.classList.remove('bg-accent-primary', 'text-white'));
                e.currentTarget.classList.add('bg-accent-primary', 'text-white');
                renderHemodex(e.currentTarget.dataset.filter);
            }));

            uploadCellPhotoInput.addEventListener('change', (e) => handlePhotoUpload(e));
            downloadPdfBtn.addEventListener('click', generatePDF);

            researchNotesInput.addEventListener('blur', (e) => {
                const itemId = dom.modal.el.dataset.id;
                if (itemId && hemoData[itemId]) {
                    hemoData[itemId].researchNotes = e.target.value;
                    saveProgress();
                }
            });

            sourceList.addEventListener('blur', (e) => {
                if (e.target.classList.contains('source-link-input')) {
                    const itemId = dom.modal.el.dataset.id;
                    if (itemId && hemoData[itemId]) {
                        const updatedSources = Array.from(sourceList.querySelectorAll('.source-link-input')).map(input => input.value);
                        hemoData[itemId].sourceLinks = updatedSources.filter(link => link.trim() !== '');
                        saveProgress();
                    }
                }
            }, true);
            
            addSourceBtn.addEventListener('click', () => {
                const itemId = dom.modal.el.dataset.id;
                if (itemId && hemoData[itemId]) {
                    hemoData[itemId].sourceLinks.push('');
                    renderSourceLinks(itemId);
                }
            });

            // Initial Setup
            loadProgress();
            updateNavStatus();
            showView('narrativa');
        });
    </script>
</body>
</html>

